<ons-page id="home-page">
	<ons-progress-bar id="loading-bar-home" value="0" indeterminate="indeterminate"></ons-progress-bar>
	<section>
		<p id="robot-state" data-i18n="home.labels.state">
			Loading state...
		</p>
		<div style="width:100%; text-align:center;">
			<p id="robot-state-details">
				<span id="robot-state-details-m2"><span data-i18n="common.area">Area</span>: <span id="robot-state-details-m2-value">0.0</span> <span data-i18n="common.m2">m²</span></span>
				<span id="robot-state-details-time"><span data-i18n="common.time">Time</span>: <span id="robot-state-details-time-value">00:00:00</span></span>
			</p>
		</div>
	</section>
	<hr style="width:98%; opacity: 0.3">

	<section id="robot-control-buttons">
		<div>
			<ons-button id="start-button" onclick="handleControlButton('start')" disabled><ons-icon icon="fa-play"></ons-icon> <span data-i18n="home.buttons.start">Start</span></ons-button>
			<ons-button id="pause-button" onclick="handleControlButton('pause')" disabled><ons-icon icon="fa-pause"></ons-icon> <span data-i18n="home.buttons.pause">Pause</span></ons-button>
			<ons-button id="resume-button" onclick="handleResumeButton()" disabled style="display:none;"><ons-icon icon="fa-redo"></ons-icon> <span data-i18n="home.buttons.resume">Resume</span></ons-button>
		</div><div>
			<ons-button id="stop-button" onclick="handleStopButton()" disabled><ons-icon icon="fa-stop"></ons-icon> <span data-i18n="home.buttons.stop">Stop</span></ons-button>
			<ons-button id="home-button" onclick="handleHomeButton()" disabled><ons-icon icon="fa-charging-station"></ons-icon> <span data-i18n="home.buttons.home">Home</span></ons-button>
		</div><div>
			<ons-button id="spot-button" onclick="handleControlButton('spot')" disabled><ons-icon icon="fa-chevron-circle-down"></ons-icon> <span data-i18n="home.buttons.spot">Spot</span></ons-button>
			<ons-button id="area-button" onclick="handleAreaButton()" disabled><ons-icon icon="fa-share-square"></ons-icon> <span data-i18n="home.buttons.zones">Zones</span></ons-button>
		</div><div>
			<ons-button id="go-to-button" onclick="handleGoToButton()" disabled><ons-icon icon="fa-map-marker"></ons-icon> <span data-i18n="home.buttons.goto">Go to</span></ons-button>
			<ons-button id="find-robot-button" onclick="handleControlButton('find')" disabled><ons-icon icon="fa-volume-up"></ons-icon> <span data-i18n="home.buttons.find">Find</span></ons-button>
		</div><div id="multimap-buttons" style="display: none;">
			<ons-button id="store-map-button" onclick="handleStoreMapButton()" disabled><ons-icon icon="fa-file-export"></ons-icon> <span data-i18n="home.buttons.storeMap">Store Map</span></ons-button>
			<ons-button id="load-map-button" onclick="handleLoadMapButton()" disabled><ons-icon icon="fa-file-import"></ons-icon> <span data-i18n="home.buttons.loadMap">Load Map</span></ons-button>
		</div><div>
			<ons-button id="fanspeed-button" onclick="handleFanspeedButton()" disabled><ons-icon icon="fa-superpowers"></ons-icon> <span data-i18n="home.buttons.unknownPower">Unknown power</span></ons-button>
			<ons-button id="watergrade-button" onclick="handleWaterGradeButton()" style="display:none;" disabled><ons-icon icon="fa-tint"></ons-icon> <span data-i18n="home.buttons.unknownWaterGrade">Unknown Water Grade</span></ons-button>
		</div>
	</section>
	<hr style="width:98%; opacity: 0.3">

	<section style="margin: 10px 16px">
		<p id="waterbox-status-text" style="display:none;">
			<span data-i18n="common.waterbox">Waterbox</span>: <span id="waterbox-status-text-value"></span>
		</p>
		<p id="mop-status-text" style="display:none;">
			<span data-i18n="common.mop">Mop</span>: <span id="mop-status-text-value"></span>
		</p>
		<p id="battery-status-text">
			<span data-i18n="common.battery">Battery</span>: <span id="battery-status-text-value">0</span>%
		</p>
		<p>
			<ons-progress-bar id="battery-status-bar" secondary-value="100"></ons-progress-bar>
		</p>
	</section>


	<script>
		var currentRefreshTimer, refreshInProgress = false;

		var startButton = document.getElementById("start-button"),
			pauseButton = document.getElementById("pause-button"),
			resumeButton = document.getElementById("resume-button"),
			stopButton = document.getElementById("stop-button"),
			spotButton = document.getElementById("spot-button"),
			goToButton = document.getElementById("go-to-button"),
			areaButton = document.getElementById("area-button"),
			storeMapButton = document.getElementById("store-map-button"),
			loadMapButton = document.getElementById("load-map-button"),
			fanspeedButton = document.getElementById("fanspeed-button"),
			watergradeButton = document.getElementById("watergrade-button"),
			findRobotButton = document.getElementById("find-robot-button"),
			homeButton = document.getElementById("home-button"),
			batteryStatusText = document.getElementById('battery-status-text-value'),
			batteryStatusBar = document.getElementById('battery-status-bar'),
			robotState = document.getElementById('robot-state'),
			robotStateDetailsM2 = document.getElementById("robot-state-details-m2-value"),
			robotStateDetailsTime = document.getElementById("robot-state-details-time-value"),
			waterBoxStatus = document.getElementById("waterbox-status-text"),
			mopInstallStatus = document.getElementById("mop-status-text"),
			waterBoxStatusValue = document.getElementById("waterbox-status-text-value"),
			mopInstallStatusValue = document.getElementById("mop-status-text-value"),
			loadingBarHome = document.getElementById('loading-bar-home');

		var fanspeedPresets = {};
		var waterGradePresets = {};

		var BUTTONS = {
			"start": {
				button: startButton,
				url: "api/start_cleaning"
			},
			"pause": {
				button: pauseButton,
				url: "api/pause_cleaning"
			},
			"find": {
				button: findRobotButton,
				url: "api/find_robot"
			},
			"spot": {
				button: spotButton,
				url: "api/spot_clean"
			}
		};

		if (!ons.platform.isAndroid()) {
			var progressStyle = document.querySelectorAll('.progressStyle');
			for (progress of progressStyle) { //How Why Help
				progress.hasAttribute('modifier') ?
					progress.setAttribute('modifier', progress.getAttribute('modifier') + ' ios') :
					progress.setAttribute('modifier', 'ios');
			}
		}

		function handleControlButton(button) {
			let btn = BUTTONS[button];
			if (btn === undefined) {
				return fn.notificationToastError(i18next.t('home.buttons.invalid',"Invalid button"));
			}
			btn.button.setAttribute("disabled", "disabled");
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			fn.prequest(btn.url, "PUT")
			.then(() => {
				clearTimeout(currentRefreshTimer);
				setTimeout(() => updateHomePage(), 500);
			})
			.catch(err => {
				btn.button.removeAttribute("disabled");
				loadingBarHome.removeAttribute("indeterminate");
				fn.notificationToastError(err);
			});
		}

		function handleStopButton() {
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			stopButton.setAttribute("disabled", "disabled");
			Promise.resolve()
			.then(res => {
				if (fn.device.state === 6 && !fn.device.features.v3) {
					return fn.prequest("api/pause_cleaning", "PUT").then(res => new Promise(res => setTimeout(res,19e2)));
				}
			})
			.then(res => fn.prequest("api/stop_cleaning", "PUT"))
			.then(() => {
				clearTimeout(currentRefreshTimer);
				setTimeout(() => updateHomePage(), 500);
			})
			.catch(err => {
				stopButton.removeAttribute("disabled");
				loadingBarHome.removeAttribute("indeterminate");
				fn.notificationToastError(err);
			});
		}

		function handleHomeButton() {
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			homeButton.setAttribute("disabled", "disabled");
			Promise.resolve()
			.then(res => {
				if ([5,11,16,17,18].includes(fn.device.state) && !fn.device.features.v3) {
					return fn.prequest("api/stop_cleaning", "PUT").then(res => new Promise(res => setTimeout(res,19e2)));
				}
			})
			.then(res => fn.prequest("api/drive_home", "PUT"))
			.then(() => {
				clearTimeout(currentRefreshTimer);
				setTimeout(() => updateHomePage(), 500);
			})
			.catch(err => {
				homeButton.removeAttribute("disabled");
				loadingBarHome.removeAttribute("indeterminate");
				fn.notificationToastError(err);
			});
		}

		function handleFanspeedButton() {
			clearTimeout(currentRefreshTimer);
			ons.openActionSheet({
				title: i18next.t('home.popups.selectFanspeed',"Select power mode:"),
				cancelable: true,
				buttons: [
					...Object.values(fanspeedPresets),
					{
						label: i18next.t('common.cancel',"Cancel"),
						icon: 'md-close'
					}
				]
			})
			.then(index => {
				var level = Object.keys(fanspeedPresets)[index];
				if (level) {
					loadingBarHome.setAttribute("indeterminate", "indeterminate");
					fanspeedButton.setAttribute("disabled", "disabled");
					fn.prequestWithPayload("api/fanspeed", JSON.stringify({ speed: level }), "PUT")
					.then(() => {
						clearTimeout(currentRefreshTimer);
						setTimeout(() => updateHomePage(), 500);
					})
					.catch(err => {
						fanspeedButton.removeAttribute("disabled");
						loadingBarHome.removeAttribute("indeterminate");
						fn.notificationToastError(err);
					});
				} else {
					currentRefreshTimer = setTimeout(() => updateHomePage(), 3000);
				}
			});
		}

		function handleWaterGradeButton() {
			clearTimeout(currentRefreshTimer);
			ons.openActionSheet({
				title: i18next.t('home.popups.selectWaterGrade',"Select water grade:"),
				cancelable: true,
				buttons: [
					...Object.values(waterGradePresets),
					{
						label: i18next.t('common.cancel',"Cancel"),
						icon: 'md-close'
					}
				]
			})
			.then(index => {
				var level = Object.keys(waterGradePresets)[index];
				if (level) {
					loadingBarHome.setAttribute("indeterminate", "indeterminate");
					watergradeButton.setAttribute("disabled", "disabled");
					fn.prequestWithPayload("api/watergrade", JSON.stringify({ speed: level }), "PUT")
					.then(() => {
						clearTimeout(currentRefreshTimer);
						setTimeout(() => updateHomePage(), 500);
					})
					.catch(err => {
						watergradeButton.removeAttribute("disabled");
						loadingBarHome.removeAttribute("indeterminate");
						fn.notificationToastError(err);
					});
				} else {
					currentRefreshTimer = setTimeout(() => updateHomePage(), 3000);
				}
			});
		}

		function handleGoToButton() {
			clearTimeout(currentRefreshTimer);
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			var spots;
			fn.prequest("api/spots")
			.then(res => {
				loadingBarHome.removeAttribute("indeterminate");
				spots = res;
				spots.sort((a, b) => a.name.localeCompare(b.name));
				var options = [];
				for (var i = 0; i < spots.length; i++) {
					options.push(spots[i].name);
				}
				options.push({
					label: i18next.t('common.cancel',"Cancel"),
					icon: 'md-close'
				});
				let openActionSheet = ons.openActionSheet({
					title: i18next.t('home.popups.selectGotoTarget',"Select go to target:"),
					cancelable: true,
					buttons: options
				});
				var spotButtons = document.querySelectorAll('ons-action-sheet-button');
				for (var i = 0; i < spotButtons.length; i++) {
					if (!i) spotButtons[i].parentNode.parentNode.title = '';
					spotButtons[i].title = ''; // get rid of stupid title repeating on all buttons
				}
				return openActionSheet;
			}).then(index => {
				if(index > -1 && index < spots.length) {
					if (spots[index].coordinates[0] === null) spots[index].coordinates = [25500,25500]; // todo: show message about spot is undefined or something
					if (!fn.webifSettings.gotoImmediate) {
						pushView(1,'map.html');
						document.getElementById('appTabbar').setActiveTab(1,{callback: function() {
							updateMapPage(true).then(function(map) {
								map.addSpot(spots[index].coordinates);
							})
							.catch(() => {});
						}});
						return Promise.reject("cancel");
					} else {
						return Promise.resolve()
						.then(res => {
							if (fn.device.state === 6) {
								return fn.prequest("api/pause_cleaning", "PUT").then(res => new Promise(res => setTimeout(res,19e2)));
							}
						})
						.then(res => fn.prequestWithPayload("api/go_to", JSON.stringify({x: spots[index].coordinates[0],y: spots[index].coordinates[1]}), "PUT"));
					}
				}
				return Promise.reject("cancel");
			})
			.then(res => fn.notificationToastOK())
			.catch(e => {
				if (e !== "cancel") fn.notificationToastError(e);
			})
			.finally(() => setTimeout(() => updateHomePage(), 200));
		}

		function handleResumeButton() {
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			resumeButton.setAttribute("disabled", "disabled");
			fn.prequest("api/current_status")
			.then(res => {
				if ([2,10,12].includes(res.state)) {
					if (res.in_returning === 1 || fn.device.features.nret && res.in_cleaning === 0 && res.state === 10) {
						fn.prequest("api/drive_home", "PUT")
						.then(()=> {
							clearTimeout(currentRefreshTimer);
							setTimeout(() => updateHomePage(), 200);
						})
						return;
					} else if (res.in_cleaning > 0) {
						fn.prequest("api/start_cleaning", "PUT")
						.then(()=> {
							clearTimeout(currentRefreshTimer);
							setTimeout(() => updateHomePage(), 200);
						})
						return;
					}
				}
			})
			.catch(err => {
				if (err !== "cancel") fn.notificationToastError(err);
			})
		}

		function handleAreaButton() {
			clearTimeout(currentRefreshTimer);
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			var zones, payload, calcPayload, markSubmitButton, zoneNumber = 0;
			fn.prequest("api/zones")
			.then(res => {
				loadingBarHome.removeAttribute("indeterminate");
				zones = res;
				zones.sort((a, b) => a.name.localeCompare(b.name));
				var options = [];
				for(var i = 0; i < zones.length; i++) {
					options.push(zones[i].name);
				}
				options.push({
					label: i18next.t('common.submit',"Submit"),
					icon: 'md-collection-item'
				},{
					label: i18next.t('common.cancel',"Cancel"),
					icon: 'md-close'
				});
				let openActionSheet = ons.openActionSheet({
					title: i18next.t('home.popups.selectZones',"Select zones for cleaning:"),
					cancelable: true,
					buttons: options
				});
				document.querySelector('ons-action-sheet').classList.add('ons-action-sheet-zoned');
				var zoneButtons = document.querySelectorAll('ons-action-sheet-button');
				for (var i = 0; i < zoneButtons.length; i++) {
					if (!i) zoneButtons[i].parentNode.parentNode.title = '';
					zoneButtons[i].title = ''; // get rid of stupid title repeating on all buttons
					if (zoneButtons[i].getAttribute('icon') === null) {
						zoneButtons[i].insertAdjacentHTML('beforeend','<label class="zone-cblabel"><input type="checkbox" class="zone-checkbox" data-id="' + i + '"></input></label><span class="zone-numspan"></span>')
					} else if (zoneButtons[i].getAttribute('icon') === 'md-close') {
						zoneButtons[i].classList.add('action-sheet-button-zcancel','action-sheet-button-half');
					} else {
						zoneButtons[i].classList.add('action-sheet-button-zsubmit','action-sheet-button-half', 'zdisabled');
					}
				}
				calcPayload = function() {
					var payload = [];
					var zoneCheckboxes = document.querySelectorAll('.zone-checkbox');
					for (var i = 0; i < zoneCheckboxes.length; i++) {
						if (!zoneCheckboxes[i].dataset.num) {
							continue;
						}
						payload[zoneCheckboxes[i].dataset.num - 1] = zones[zoneCheckboxes[i].dataset.id].coordinates;
					}
					return payload.reduce((acc, val) => acc.concat(val), []);
				}
				markSubmitButton = function() {
					var submitButton = document.querySelector('.action-sheet-button[icon="md-collection-item"]');
					if (!submitButton) return;
					submitButton.classList.toggle('zdisabled',!calcPayload().length);
				}
				document.querySelector('ons-action-sheet').addEventListener('click',function(e) {
					if (e.button || e.target.getAttribute('icon') === 'md-close') { return; }
					if (e.target.className === 'zone-cblabel') {
						e.stopPropagation();
						return;
					}
					if (e.target.className === 'zone-checkbox') {
						e.stopPropagation();
						if (e.target.checked) {
							// checked right now
							e.target.dataset.num = ++zoneNumber;
							e.target.parentNode.nextElementSibling.textContent = '[' + e.target.dataset.num + '/' + zones[e.target.dataset.id].coordinates.length + ']';
							e.target.parentNode.parentNode.classList.add('zone_selected');
						} else {
							// unchecked
							var zoneCheckboxes = document.querySelectorAll('.zone-checkbox');
							for (var i = 0; i < zoneCheckboxes.length; i++) {
								if (zoneCheckboxes[i].checked && zoneCheckboxes[i].dataset.num > e.target.dataset.num) {
									zoneCheckboxes[i].dataset.num--;
									zoneCheckboxes[i].parentNode.nextElementSibling.textContent = '[' + zoneCheckboxes[i].dataset.num + '/' + zones[zoneCheckboxes[i].dataset.id].coordinates.length + ']';
								}
							}
							zoneNumber--;
							delete e.target.dataset.num;
							e.target.parentNode.nextElementSibling.textContent = '';
							e.target.parentNode.parentNode.classList.remove('zone_selected');
						}
						markSubmitButton();
					} else if (e.target.getAttribute('icon') === 'md-collection-item') {
						e.stopPropagation();
						if (calcPayload().length) {
							var zoneCheckboxes = document.querySelectorAll('.zone-checkbox');
							for (var i = 0; i < zoneCheckboxes.length; i++) {
								if (zoneCheckboxes[i].checked) {
									zoneCheckboxes[i].parentNode.parentNode.click();
									break;
								}
							}
						}
					} else if (zoneNumber > 0) {
						let findCheckbox = e.target.querySelector('.zone-checkbox');
						if (!findCheckbox || !findCheckbox.checked) {
							e.stopPropagation();
							var zoneCheckboxes = document.querySelectorAll('.zone-checkbox');
							for (var i = 0; i < zoneCheckboxes.length; i++) {
								if (zoneCheckboxes[i].checked) {
									delete zoneCheckboxes[i].dataset.num;
									zoneCheckboxes[i].parentNode.nextElementSibling.textContent = '';
									zoneCheckboxes[i].parentNode.parentNode.classList.remove('zone_selected');
									zoneCheckboxes[i].checked = false;
								}
							}
							zoneNumber = 0;
						} else {
							payload = calcPayload();
						}
						markSubmitButton();
					}
				},true);
				return openActionSheet;
			})
			.then(index => {
				if(index > -1 && index < zones.length){
					if (zoneNumber < 2) {
						payload = zones[index].coordinates;
					}
					if (!payload.length) {
						ons.notification.alert(i18next.t('home.popups.emptyZoneChosen',"You've chosen an empty zone to clean. Please set it up first."),{title: i18next.t('common.attention',"Attention!")});
						return Promise.reject("cancel");
					}
					if (!fn.webifSettings.zonedImmediate) {
						pushView(1,'map.html');
						document.getElementById('appTabbar').setActiveTab(1,{callback: function() {
							updateMapPage(true).then(function(map) {
								map.clearLocations();
								payload.forEach(function(zone) {
									map.addZone(zone, true);
								});
							})
							.catch(() => {});
						}});
						return Promise.reject("cancel");
					} else {
						loadingBarHome.setAttribute("indeterminate", "indeterminate");
						return Promise.resolve()
						.then(res => {
							if (fn.device.state === 6 && !fn.device.features.v3) {
								return fn.prequest("api/pause_cleaning", "PUT").then(res => new Promise(res => setTimeout(res,19e2)));
							}
						})
						.then(res => fn.prequestWithPayload("api/start_cleaning_zone", JSON.stringify(payload), "PUT"));
					}
				} else {
					return Promise.reject("cancel");
				}
			})
			.then(res => fn.notificationToastOK())
			.catch(e => {
				if (e !== "cancel") fn.notificationToastError(e);
			})
			.finally(() => setTimeout(() => updateHomePage(), 200));
		}

		function handleStoreMapButton() {
			clearTimeout(currentRefreshTimer);
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			let slotName, slots = [], options = [];
			return fn.prequest("api/list_maps")
			.then(data => {
				data.sort((a, b) => a.localeCompare(b));
				loadingBarHome.removeAttribute("indeterminate");
				slots = data;
				for (var i = 0; i < data.length; i++) {
					options.push((/^[0-9]+$/.test(data[i]) ? i18next.t('home.popups.slotNo',"slot #") : "") + data[i]);
				}
				options.push({
					label: '[' + i18next.t('home.popups.newSave',"new save") + ']',
					icon: 'md-crop-free'
				});
				options.push({
					label: i18next.t('common.cancel',"Cancel"),
					icon: 'md-close'
				});
				let slotsList = ons.openActionSheet({
					title: i18next.t('home.popups.selectMapToSave',"Select a slot to save the map to:"),
					cancelable: true,
					buttons: options
				});
				var slotsButtons = document.querySelectorAll('ons-action-sheet-button');
				for (var i = 0; i < slotsButtons.length; i++) {
					if (!i) slotsButtons[i].parentNode.parentNode.title = '';
					slotsButtons[i].title = ''; // get rid of stupid title repeating on all buttons
					if (slotsButtons[i].getAttribute('icon') === null) {
						slotsButtons[i].insertAdjacentHTML('beforeend','<span class="remove-stored-map" data-id="' + i + '"><i class="fas fa-times"></i></span>')
					}
				}
				document.querySelector('ons-action-sheet').addEventListener('click',function(e) {
					if (e.button || e.target.getAttribute('icon') === 'md-close') { return; }
					if (e.target.className === 'remove-stored-map') {
						e.stopPropagation();
						slotName = slots[e.target.dataset.id];
						ons.notification.confirm(i18next.t('home.popups.confirmMapDelete',{defaultValue: "Are you sure you want to delete \"{{name}}\"?",name: options[e.target.dataset.id]}),{buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.ok',"OK")], title: i18next.t('common.confirm',"Confirm")}).then(answer => {
							if (answer === 1) {
								loadingBarHome.setAttribute("indeterminate", "indeterminate");
								fn.prequestWithPayload("api/remove_map", JSON.stringify({ name: slotName }), "PUT").then(
									(res) => fn.notificationToastOK(i18next.t('home.popups.mapDeletedOK',"Stored map successfully deleted!")),
									(err) => fn.notificationToastError(err)
								)
								.finally(() => document.querySelector('ons-action-sheet ons-action-sheet-button:last-of-type').click());
							}
						});
					}
				},true);
				return slotsList;
			})
			.then(index => {
				if (index > -1 && index < slots.length) {
					slotName = slots[index];
					return 1;
				} else if (index === slots.length) {
					return ons.notification.prompt({message: i18next.t('home.popups.chooseMapName',"Choose a title to save the map files as:"), title: i18next.t('common.prompt',"Prompt"), placeholder: "name", cancelable: true, buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.ok',"OK")] })
					.then(slot => {
						if (slot === null) {
							return Promise.reject("cancel");
						}
						slot = slot.trim();
						if (!/^[a-zа-яё0-9\-_\ ]+$/i.test(slot)) {
							return Promise.reject(i18next.t('home.popups.invalidMapName',"Title may contain only latin letters or numbers, spaces and hyphen."));
						}
						slotName = slot;
						if (slots.includes(slotName)) {
							return 1;
						}
						return 0;
					});
				} else {
					return Promise.reject("cancel");
				}
			})
			.then(overwrite => {
				if (overwrite) {
					return ons.notification.confirm((/^[0-9]+$/.test(slotName) ? i18next.t('home.popups.slotAlreadyTaken',{defaultValue: "Slot #{{slot}} is already occupied", slot: slotName}) : i18next.t('home.popups.nameAlreadyTaken',{defaultValue: "Name \"{{name}}\" is already taken", name: slotName})) + ". " + i18next.t('common.overwrite',"Overwrite") + "?",{buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.overwrite',"Overwrite")], title: i18next.t('common.confirm',"Confirm")});
				} else {
					return 1;
				}
			})
			.then(res => {
				if (res === 0) {
					return Promise.reject("cancel");
				}
				loadingBarHome.setAttribute("indeterminate", "indeterminate");
				return fn.prequestWithPayload("api/store_map", JSON.stringify({name: slotName}), "PUT");
			})
			.then(res => fn.notificationToastOK(i18next.t('home.popups.mapStoredOK',"Map stored successfully!")))
			.catch(err => {
				if (err !== "cancel") fn.notificationToastError(err);
			})
			.finally(() => setTimeout(() => updateHomePage(), 500));
		}

		function handleLoadMapButton() {
			clearTimeout(currentRefreshTimer);
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			let slotName, slots = [], options = [];
			fn.prequest("api/list_maps")
			.then(data => {
				data.sort((a, b) => a.localeCompare(b));
				loadingBarHome.removeAttribute("indeterminate");
				slots = data;
				for (var i = 0; i < data.length; i++) {
					options.push((/^[0-9]+$/.test(data[i]) ? i18next.t('home.popups.slotNo',"slot #") : "") + data[i]);
				}
				options.push({
					label: options.length ? i18next.t('common.cancel',"Cancel") : i18next.t('home.popups.noMapsStored',"No saved maps!"),
					icon: 'md-close'
				});
				let slotsList = ons.openActionSheet({
					title: i18next.t('home.popups.selectMapToLoad',"Select a slot to load the map from:"),
					cancelable: true,
					buttons: options
				});
				var slotsButtons = document.querySelectorAll('ons-action-sheet-button');
				for (var i = 0; i < slotsButtons.length; i++) {
					if (!i) slotsButtons[i].parentNode.parentNode.title = '';
					slotsButtons[i].title = ''; // get rid of stupid title repeating on all buttons
					if (slotsButtons[i].getAttribute('icon') === null) {
						slotsButtons[i].insertAdjacentHTML('beforeend','<span class="remove-stored-map" data-id="' + i + '"><i class="fas fa-times"></i></span>')
					}
				}
				document.querySelector('ons-action-sheet').addEventListener('click',function(e) {
					if (e.button || e.target.getAttribute('icon') === 'md-close') { return; }
					if (e.target.className === 'remove-stored-map') {
						e.stopPropagation();
						let slotName = slots[e.target.dataset.id];
						ons.notification.confirm(i18next.t('home.popups.confirmMapDelete',{defaultValue: "Are you sure you want to delete \"{{name}}\"?",name: options[e.target.dataset.id]}),{buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.ok',"OK")], title: i18next.t('common.confirm',"Confirm")}).then(answer => {
							if (answer === 1) {
								loadingBarHome.setAttribute("indeterminate", "indeterminate");
								fn.prequestWithPayload("api/remove_map", JSON.stringify({ name: slotName }), "PUT").then(
									(res) => fn.notificationToastOK(i18next.t('home.popups.mapDeletedOK',"Stored map successfully deleted!")),
									(err) => fn.notificationToastError(err)
								)
								.finally(() => document.querySelector('ons-action-sheet ons-action-sheet-button:last-of-type').click());
							}
						});
					}
				},true);
				return slotsList;
			})
			.then(index => {
				if (index > -1 && index < slots.length) {
					document.querySelectorAll('#robot-control-buttons ons-button').forEach(button => button.setAttribute('disabled','disabled'));
					slotName = slots[index];
					return ons.notification.confirm(i18next.t('home.popups.confirmMapLoad',{defaultValue: "Are you sure you want to load map \"{{name}}\"?", name: slotName}),{buttonLabels: [i18next.t('common.cancel',"Cancel"), i18next.t('common.ok',"OK")], title: i18next.t('common.confirm',"Confirm")});
				} else {
					return Promise.reject("cancel");
				}
			})
			.then(res => {
				if (res === 0) {
					return Promise.reject("cancel");
				}
				loadingBarHome.setAttribute("indeterminate", "indeterminate");
				return fn.prequestWithPayload("api/load_map", JSON.stringify({name: slotName}), "PUT");
			})
			.then(res => {
				if (res.message === 'wait') {
					let waiting = ons.notification.alert(i18next.t('home.popups.waitMapTicks',{defaultValue: "Map replacement routines are running. Please wait for {{seconds}} seconds...", seconds: 30}),{class: 'load-map-waiting', title: i18next.t('home.popups.wait',"Wait"), cancelable: false});
					let adb = document.querySelector('.load-map-waiting .alert-dialog-button'),
						adc = document.querySelector('.load-map-waiting .alert-dialog-content'),
						adt = document.querySelector('.load-map-waiting .alert-dialog-title'),
						adi = setInterval(() => {
							let seconds = +(adc.textContent.match(/(\d+)/) || [])[1] || 0;
							if (seconds <= 1) {
								clearInterval(adi);
								adb.classList.remove('ok-disabled');
								adt.textContent = i18next.t('home.popups.waitMapFinished',"Finished");
								adc.textContent = i18next.t('home.popups.waitMapEncourage',"Requested routines should be completed now.");
							} else {
								adc.textContent = adc.textContent.replace(seconds,--seconds);
							}
						},1e3);
					adb.classList.add('ok-disabled');
					return waiting;
				}
				return true;
			})
			.then(res => fn.notificationToastOK(i18next.t('home.popups.mapRestoredOK',"Map restored successfully!")))
			.catch(err => {
				if (err !== "cancel") fn.notificationToastError(err);
			})
			.finally(() => setTimeout(() => updateHomePage(), 200));
		}

		function updateHomePage() {
			if (refreshInProgress || document.querySelector('ons-tabbar ons-tab.active').page !== "home.html") { // workaround: due to bug in onsenui sometimes 'shown' attribute remains on a hidden page, thus this hack
				return;
			}
			refreshInProgress = true;
			clearTimeout(currentRefreshTimer);
			loadingBarHome.setAttribute("indeterminate", "indeterminate");
			fn.prequest("api/current_status")
			.then((res) => {
				fn.device.state = res.state;

				batteryStatusText.textContent = res.battery;
				batteryStatusBar.value = res.battery;

				if (fn.device.features.water_box_status) {
					var waterBoxStatusTexts = {
						0: i18next.t('home.waterBoxStatusTexts.not',"Not installed"),
						1: i18next.t('home.waterBoxStatusTexts.installed',"Installed"),
					};
					waterBoxStatusValue.textContent = "" + (waterBoxStatusTexts[res.water_box_status] || `Unknown ${res.water_box_status}`);
				}
				if (fn.device.features.mop_install_status) {
					var mopStatusTexts = {
						0: i18next.t('home.mopStatusTexts.not',"Carriage not installed"),
						1: i18next.t('home.mopStatusTexts.installed',"Carriage installed"),
					};
					mopInstallStatusValue.textContent = "" + (mopStatusTexts[res.water_box_carriage_status] || `Unknown ${res.water_box_carriage_status}`);
				}

				robotState.textContent = i18next.t('robot.states.n' + res.state, res.human_state);
				if (res.state === 12 && res.error_code !== 0) {
					robotState.textContent += ' #' + res.error_code;
				}
				if (res.in_cleaning && [8,10,12].includes(res.state)) {
					switch (res.in_cleaning) {
						case 1:
							robotState.textContent += " / " + i18next.t('robot.states.n5', "Cleaning");
							break;
						case 2:
							robotState.textContent += " / " + i18next.t('robot.states.n17', "Zoned cleaning");
							break;
						case 3:
							robotState.textContent += " / " + i18next.t('robot.states.n18', "Rooms cleaning");
							break;
					}
				}
				if (res.error_code != 0) {
					robotState.innerHTML +=
						'<span class="robot-error"><ons-icon icon="fa-exclamation-triangle"></ons-icon> ' +
						i18next.t('robot.errors.n' + res.error_code, res.human_error) +
						' <ons-icon icon="fa-exclamation-triangle"></ons-icon></span>';
				}

				if ([2,3,5,6,8,10,12,17,18].includes(res.state)) {
					startButton.removeAttribute("disabled");
				} else {
					startButton.setAttribute("disabled", "disabled");
				}

				if ([5,6,11,16,17,18].includes(res.state)) {
					pauseButton.removeAttribute("disabled");
				} else {
					pauseButton.setAttribute("disabled", "disabled");
				}

				if ([3,11,15,16].includes(res.state) || ([8,10].includes(res.state) && !(res.in_cleaning || res.in_returning))) {
					stopButton.setAttribute("disabled", "disabled");
				} else {
					stopButton.removeAttribute("disabled");
				}

				if ([2,3,5,10,11,12,16,17,18].includes(res.state)) {
					homeButton.removeAttribute("disabled");
				} else {
					homeButton.setAttribute("disabled", "disabled");
				}

				if ([2,3,10].includes(res.state)) {
					spotButton.removeAttribute("disabled");
				} else {
					spotButton.setAttribute("disabled", "disabled");
				}

				if ([2,3,8].includes(res.state) && !res.in_cleaning) {
					storeMapButton.removeAttribute("disabled");
					loadMapButton.removeAttribute("disabled");
				} else {
					storeMapButton.setAttribute("disabled", "disabled");
					loadMapButton.setAttribute("disabled", "disabled");
				}

				if (res.state === 10 || ([2,12].includes(res.state) && res.in_cleaning > 0)) {
					document.getElementById("pause-button").style.display = 'none';
					document.getElementById("resume-button").style.display = '';
					resumeButton.removeAttribute("disabled");
				} else {
					document.getElementById("pause-button").style.display = '';
					document.getElementById("resume-button").style.display = 'none';
					resumeButton.setAttribute("disabled", "disabled");
				}

				robotStateDetailsM2.textContent = ("00" + (res.clean_area / 1000000).toFixed(2)).slice(-6);
				robotStateDetailsTime.textContent = fn.secondsToHms(res.clean_time);

				fanspeedPresets = !fn.device.features.v3 ? {
					1: i18next.t('home.fanspeedPresets.whisper',"Whisper"),
					38: i18next.t('home.fanspeedPresets.quiet',"Quiet"),
					60: i18next.t('home.fanspeedPresets.balanced',"Balanced"),
					75: i18next.t('home.fanspeedPresets.turbo',"Turbo"),
					100: i18next.t('home.fanspeedPresets.max',"Max")
				} : {
					101: i18next.t('home.fanspeedPresets.quiet',"Quiet"),
					102: i18next.t('home.fanspeedPresets.balanced',"Balanced"),
					103: i18next.t('home.fanspeedPresets.turbo',"Turbo"),
					104: i18next.t('home.fanspeedPresets.max',"Max")
				};
				if (!fn.device.features.nmop) {
					fanspeedPresets[105] = i18next.t('home.fanspeedPresets.mop',"Mop");
				}
				fanspeedButton.innerHTML = "<ons-icon icon=\"fa-superpowers\"></ons-icon> " + (fanspeedPresets[res.fan_power] || `Custom ${res.fan_power}%`);
				if (fn.device.features.water_usage_ctrl) {
					waterGradePresets = {
						200: i18next.t('home.waterGradePresets.off',"Off"),
						201: i18next.t('home.waterGradePresets.low',"Low"),
						202: i18next.t('home.waterGradePresets.medium',"Medium"),
						203: i18next.t('home.waterGradePresets.high',"High"),
					};
					watergradeButton.innerHTML = "<ons-icon icon=\"fa-tint\"></ons-icon> " + (waterGradePresets[res.water_box_mode] || `Custom ${res.water_box_mode}%`);
				}
			}, (err) => fn.notificationToastError(err))
			.finally(() => {
				refreshInProgress = false;
				loadingBarHome.removeAttribute("indeterminate");
				fanspeedButton.removeAttribute("disabled");
				if (fn.device.features.water_usage_ctrl) {
					watergradeButton.removeAttribute("disabled");
					watergradeButton.style.display = "";
				}
				if (fn.device.features.water_box_status) {
					waterBoxStatus.style.display = "";
				}
				if (fn.device.features.mop_install_status) {
					mopInstallStatus.style.display = "";
				}
				findRobotButton.removeAttribute("disabled");
				currentRefreshTimer = setTimeout(() => updateHomePage(), 5e3)
			});
		};

		ons.getScriptPage().onInit = function() {
			fn.localize('#home-page');
		}

		ons.getScriptPage().onHide = function () {
			clearTimeout(currentRefreshTimer);
		}

		ons.getScriptPage().onShow = function () {
			/* multimap visibility */
			document.getElementById('multimap-buttons').style.display = fn.webifSettings.showMultimap ? '' : 'none';
			/* check for area and go to configuration */
			Promise.all([
				fn.prequest("api/zones").then(res => res.length > 0 && areaButton.removeAttribute("disabled")),
				fn.prequest("api/spots").then(res => res.length > 0 && goToButton.removeAttribute("disabled"))
			])
			.catch(err => fn.notificationToastError(err))
			.finally(() => {
				updateHomePage();
			});
		};

	</script>
	<style>
		#robot-state {
			text-align: center;
			font-size: 1.2em;
			font-weight: 500;
		}

		.robot-error {
			color: #eb5959;
			display: block;
		}

		#robot-control-buttons {
			text-align: center;
		}

		#robot-control-buttons ons-button {
			margin: 0.25em 0.15em;
			font-size: 1.1em;
			width: 44%;
		}

		#robot-state-details-m2 {
			margin-right: 5%;
		}

		#robot-state-details-time {
			text-align: right;
		}

		.action-sheet {
			max-height: 100%;
			overflow-y: auto;
		}
		.action-sheet-button.zone_selected {
			background-color: #c9c9c9;
		}
		.action-sheet-button .zone-numspan {
			font-size: 0.67em;
			font-weight: 700;
			pointer-events: none;
			position: absolute;
			right: 3.5em;
		}
		.action-sheet-button .zone-cblabel {
			position: absolute;
			right: 0;
			padding: 0 0.8em;
		}
		.action-sheet-button .remove-stored-map {
			position: absolute;
			right: 5px;
			padding: 0 0.8em;
			cursor: pointer;
			color: black;
		}
		.action-sheet-button .remove-stored-map i {
			pointer-events: none;
		}
		.ons-action-sheet-zoned .action-sheet-button:nth-last-of-type(3) {
			border-bottom-right-radius: 12px;
			border-bottom-left-radius: 12px;
		}
		.ons-action-sheet-zoned .action-sheet-button--material:nth-last-of-type(3) {
			border-radius: 0;
		}
		.ons-action-sheet-zoned .action-sheet-button-half {
			width: 49.86%;
			border-radius: 12px;
			margin: 8px 0 0;
			background-color: #fff;
			background-image: none;
			font-weight: 600;
		}
		.ons-action-sheet-zoned .action-sheet-button--material.action-sheet-button-half {
			width: 50%;
			border-radius: 0;
			margin: 0;
			background-color: #fff;
			background-image: none;
			font-weight: 400;
		}
		.ons-action-sheet-zoned .action-sheet-button-zsubmit {
			float: left;
		}
		.ons-action-sheet-zoned .action-sheet-button-zcancel {
			float: right;
		}
		.ons-action-sheet-zoned .action-sheet-button-zsubmit.zdisabled {
			color: darkgray;
		}
		.ons-action-sheet-zoned .action-sheet-button-zsubmit.zdisabled:active {
			background-color: #fff;
		}
		.ons-action-sheet-zoned .zone-checkbox {
			transform: scale(1.5);
		}
		.load-map-waiting .ok-disabled {
			color: silver;
			pointer-events: none;
		}
		.load-map-waiting .ok-disabled:active {
			background-color: inherit;
		}
		#battery-status-bar > div {
			height: 6px;
		}
		#battery-status-bar > div::before {
			content: " ";
			display: block;
			position: absolute;
			z-index: 10000;
			width: 100%;
			height: 6px;
			background:  repeating-linear-gradient(90deg, #ddd, #ddd 1px, transparent 1px, transparent calc(10% - 1px), #ddd calc(10% - 1px), #ddd 10%)
		}
	</style>

</ons-page>
